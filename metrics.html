<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Ralph - Metrics Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 30px;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #0f172a;
        }

        .header p {
            font-size: 1.1rem;
            color: #64748b;
            font-weight: 400;
        }

        .nav-links {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 16px;
        }

        .nav-link {
            background: #3b82f6;
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .nav-link:hover {
            background: #2563eb;
        }

        .floating-refresh {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid #e2e8f0;
        }

        .floating-refresh .nav-link {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .floating-refresh .nav-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        /* Issues Section Styles */
        .add-issue-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .add-issue-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .issue-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
        }

        .issue-item:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .issue-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .issue-checkbox.checked {
            background: #10b981;
            border-color: #10b981;
        }

        .issue-checkbox.checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .issue-text {
            flex: 1;
            font-size: 0.9rem;
            color: #374151;
            border: none;
            background: transparent;
            outline: none;
            padding: 4px 0;
        }

        .issue-text.completed {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .issue-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .issue-item:hover .issue-actions {
            opacity: 1;
        }

        .issue-delete {
            background: #dc2626;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .issue-delete:hover {
            background: #b91c1c;
        }

        #empty-issues {
            display: block;
        }

        #empty-issues.hidden {
            display: none;
        }

        /* Split Layout Styles */
        .split-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            align-items: start;
        }

        .split-left,
        .split-right {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e2e8f0;
            min-height: 400px;
        }

        .split-left .chart-header,
        .split-right .chart-header {
            margin: 0 0 20px 0;
            padding: 0;
            border: none;
        }

        /* Issue Filter Tabs */
        .issue-filter-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 20px;
            background: #f1f5f9;
            border-radius: 6px;
            padding: 2px;
        }

        .filter-tab {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .filter-tab:hover {
            color: #334155;
            background: #e2e8f0;
        }

        .filter-tab.active {
            background: #1e293b;
            color: white;
        }

        /* Inline Add Issue Button */
        .add-issue-container {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f1f5f9;
        }

        .add-issue-btn-inline {
            width: 100%;
            background: #f8fafc;
            color: #64748b;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .add-issue-btn-inline:hover {
            background: #f1f5f9;
            border-color: #9ca3af;
            color: #374151;
        }

        /* Responsive design for split layout */
        @media (max-width: 1024px) {
            .split-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .metric-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .metric-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f1f5f9;
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-size: 1.25rem;
            color: white;
            background: #3b82f6;
        }

        .metric-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #0f172a;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .metric-change {
            display: flex;
            align-items: center;
            margin-top: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .metric-change.positive {
            color: #10b981;
        }

        .metric-change.negative {
            color: #ef4444;
        }

        .metric-change.neutral {
            color: #64748b;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }

        .chart-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f1f5f9;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #0f172a;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #0f172a;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            color: #374151;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .status-completed {
            background: #dcfce7;
            color: #15803d;
        }

        .status-pending {
            background: #fef3c7;
            color: #d97706;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: #3b82f6;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.success {
            background: #10b981;
        }

        .progress-fill.warning {
            background: #f59e0b;
        }

        .progress-fill.danger {
            background: #ef4444;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }



        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 8px;
            color: #475569;
        }

        .empty-state p {
            font-size: 0.875rem;
            max-width: 400px;
            margin: 0 auto;
        }

        /* Enhanced table styles */
        .enhanced-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font-size: 0.875rem;
        }

        .enhanced-table th,
        .enhanced-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .enhanced-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #0f172a;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .enhanced-table td {
            color: #374151;
        }

        .enhanced-table tr:hover {
            background: #f8fafc;
        }

        .enhanced-table .highlight {
            background: #dbeafe;
            font-weight: 600;
        }

        .enhanced-table .near-goal {
            background: #fef3c7;
            font-weight: 600;
        }

        .enhanced-table .achieved-goal {
            background: #dcfce7;
            font-weight: 600;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .table-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px 16px;
            min-width: 120px;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* Grading Legend Styles */
        .grading-legend {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .grading-legend h4 {
            margin: 0;
            color: #0f172a;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .legend-toggle {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s ease;
        }

        .legend-toggle:hover {
            background: #2563eb;
        }

        .toggle-icon {
            font-size: 0.75rem;
            transition: transform 0.2s ease;
        }

        .legend-grid.collapsed {
            display: none;
        }

        .legend-toggle.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .legend-section h5 {
            margin: 0 0 12px 0;
            color: #0f172a;
            font-size: 1rem;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 12px;
        }

        .legend-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .legend-icon {
            font-size: 1.25rem;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .legend-text {
            font-size: 0.875rem;
            color: #374151;
            line-height: 1.4;
        }

        .threshold-legend {
            font-size: 0.75rem;
            color: #64748b;
            line-height: 1.5;
        }

        .threshold-item {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .threshold-item strong {
            color: #0f172a;
        }

        .data-source-info {
            font-size: 0.875rem;
            color: #64748b;
        }

        .data-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 12px;
        }

        .data-icon {
            font-size: 1.25rem;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .data-text {
            line-height: 1.4;
        }

        .data-text strong {
            color: #0f172a;
        }

        .progress-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .progress-excellent {
            background: #10b981;
        }

        .progress-good {
            background: #3b82f6;
        }

        .progress-average {
            background: #f59e0b;
        }

        .progress-poor {
            background: #ef4444;
        }

        /* Simple CSS-only tooltip styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            margin-left: 8px;
            transition: background 0.2s ease;
        }

        .tooltip-icon:hover {
            background: #2563eb;
        }

        .tooltip-content {
            position: absolute;
            bottom: 125%;
            left: -5px;
            background: #1e293b;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            line-height: 1.4;
            font-weight: 400;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            pointer-events: none;
            width: 300px;
            white-space: normal;
        }

        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 20px;
            border: 5px solid transparent;
            border-top-color: #1e293b;
        }

        .tooltip-container:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }

        /* Deal Flow Chart Styles */
        .deal-flow-chart {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
            width: 100%;
            box-sizing: border-box;
        }
        
        .flow-container {
            display: flex;
            align-items: flex-start;
            justify-content: space-around;
            flex-wrap: nowrap;
            padding: 20px 10px;
            min-height: 350px;
            max-width: 100%;
            gap: 8px;
            overflow-x: auto;
        }
        
        .flow-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 90px;
            flex: 1;
            max-width: 120px;
            position: relative;
        }
        
        .flow-stage.fork {
            margin-left: 40px;
        }
        
        .stage-node {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            background: #64748b;
            margin-bottom: 8px;
            font-size: 0.7rem;
            text-align: center;
            line-height: 1.1;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stage-node.success {
            background: #10b981;
        }
        
        .stage-node.dead {
            background: #ef4444;
        }
        
        .stage-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
            text-align: center;
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .stage-percentage {
            font-size: 0.7rem;
            color: #64748b;
            text-align: center;
        }
        
        .flow-connector {
            width: 30px;
            height: 3px;
            background: transparent;
            flex-shrink: 0;
            align-self: flex-start;
            margin-top: 25px;
            position: relative;
        }
        
        .flow-connector::after {
            content: '→';
            position: absolute;
            right: -15px;
            top: -20px;
            color: #94a3b8;
            font-size: 36px;
            font-weight: bold;
            z-index: 10;
            display: block;
        }
        
        .fork-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: flex-start;
            position: relative;
        }
        
        .fork-connector {
            position: absolute;
            left: -40px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 2px;
            background: #d1d5db;
        }
        
        .fork-connector::before {
            content: '';
            position: absolute;
            right: 0;
            top: -20px;
            width: 2px;
            height: 40px;
            background: #d1d5db;
        }
        
        .fork-branch {
            width: 2px;
            height: 20px;
            background: #d1d5db;
            position: absolute;
            right: 0;
        }
        
        .fork-branch.top {
            top: -20px;
        }
        
        .fork-branch.bottom {
            bottom: -20px;
        }
        
        /* Side branch styles for VIN Sold */
        .flow-stage-with-branch {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 90px;
            flex: 1;
            max-width: 120px;
            position: relative;
            margin-bottom: 120px;
        }
        
        .main-flow-path {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .side-branch {
            position: absolute;
            top: 130px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
        }
        
        .branch-connector {
            width: 2px;
            height: 25px;
            background: #94a3b8;
            position: relative;
        }
        
        .branch-connector::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -4px;
            width: 0;
            height: 0;
            border-top: 10px solid #94a3b8;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }
        
        .flow-stage.branch {
            margin-top: 10px;
        }



        @media (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .metric-card {
                padding: 24px;
            }

            .nav-links {
                position: static;
                justify-content: center;
                margin-top: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Floating Refresh Button -->
        <div class="floating-refresh">
            <a href="#" class="nav-link" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </a>
        </div>

        <!-- Deal Summary -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">Deal Summary</div>
            </div>
            
            <!-- Progress Bar Section -->
            <div class="progress-section" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                <div class="progress-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: #0f172a; font-size: 1.125rem; font-weight: 600;">Analysis Stage Progress</h3>
                    <div class="progress-stats" style="text-align: right;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;" id="analysis-progress-percentage">23.29%</div>
                        <div style="font-size: 0.875rem; color: #64748b; margin-top: 4px;" id="analysis-progress-text">239 of 1,026 deals</div>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden;">
                        <div class="progress-fill" id="analysis-progress-fill" style="height: 100%; background: linear-gradient(90deg, #3b82f6, #1d4ed8); border-radius: 6px; transition: width 0.8s ease; width: 23.29%;"></div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Mystery Shop Metrics -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">Mystery Shop Metrics</div>
            </div>
            <div class="mystery-shop-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 24px;">
                <div class="summary-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: #0f172a; margin-bottom: 8px;" id="scored-mystery-shops">594</div>
                    <div style="font-size: 0.9rem; color: #64748b; font-weight: 500; line-height: 1.4;">
                        Scored Mystery Shops
                        <div class="tooltip-container">
                            <div class="tooltip-icon">i</div>
                            <div class="tooltip-content">
                                Number of mystery shop evaluations that have been completed and scored. This represents deals that have reached the "Analysis" stage.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="summary-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: #0f172a; margin-bottom: 8px;" id="target-dealerships-pct">29.7%</div>
                    <div style="font-size: 0.9rem; color: #64748b; font-weight: 500; line-height: 1.4;">
                        % of Target Dealerships
                        <div class="tooltip-container">
                            <div class="tooltip-icon">i</div>
                            <div class="tooltip-content">
                                Percentage of total dealerships that have at least one deal at the analysis stage. Calculated as: (Number of dealerships with analysis deals / Total dealerships) × 100. There are 269 total dealerships.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="summary-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: #0f172a; margin-bottom: 8px;" id="avg-per-dealership">2.97</div>
                    <div style="font-size: 0.9rem; color: #64748b; font-weight: 500; line-height: 1.4;">
                        Average per Dealership
                        <div class="tooltip-container">
                            <div class="tooltip-icon">i</div>
                            <div class="tooltip-content">
                                Average number of analysis deals per dealership across all dealerships. Calculated as: Total analysis deals / Total dealerships (269). This shows the average analysis deals per dealership across the entire network.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mystery Shop Scoring Section with Issues Split Layout -->
        <div class="chart-container">
            <div class="split-layout">
                <!-- Left Side: Mystery Shop Scoring Distribution -->
                <div class="split-left">
                    <div class="chart-header">
                        <div class="chart-title">Mystery Shop Scoring Distribution</div>
                    </div>
                    <div id="mystery-shop-metrics">
                        <div class="empty-state">
                            <h3>Loading Mystery Shop Metrics...</h3>
                            <p>Please wait while we fetch the scoring distribution data.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Right Side: Issues List -->
                <div class="split-right">
                    <div class="chart-header">
                        <div class="chart-title">Issues</div>
                    </div>
                    
                    <!-- Filter Tabs -->
                    <div class="issue-filter-tabs">
                        <button class="filter-tab" data-filter="all" onclick="setIssueFilter('all')">All Issues</button>
                        <button class="filter-tab active" data-filter="incomplete" onclick="setIssueFilter('incomplete')">Need to Fix</button>
                        <button class="filter-tab" data-filter="completed" onclick="setIssueFilter('completed')">Fixed</button>
                    </div>
                    
                    <div id="issues-container">
                        <div class="empty-state" id="empty-issues">
                            <h3>No Issues</h3>
                            <p>Start tracking problems and concerns.</p>
                        </div>
                        <div id="issues-list"></div>
                        <div class="add-issue-container">
                            <button class="add-issue-btn-inline" onclick="addNewIssue()">
                                <i class="fas fa-plus"></i> Add Issue
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Driver Metrics Section -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">Driver Metrics</div>
            </div>
            
            <!-- Scoreable Section -->
            <div style="margin-bottom: 32px;">
                <h4 style="margin-bottom: 16px; color: #0f172a; font-size: 1.125rem; font-weight: 600;">Scoreable</h4>
                <div id="driver-metrics-scoreable">
                    <div class="empty-state">
                        <h3>Loading Driver Metrics...</h3>
                        <p>Please wait while we fetch the latest performance data.</p>
                    </div>
                </div>
            </div>
            
            <div class="deal-states-table">
                <h4 style="margin-bottom: 16px; color: #0f172a; font-size: 1rem; font-weight: 600;">Deal States Breakdown</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>State</th>
                            <th>Count</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody id="deal-states-body">
                        <tr>
                            <td>Confirm Car</td>
                            <td>241</td>
                            <td>23.5%</td>
                        </tr>
                        <tr>
                            <td>Analysis</td>
                            <td>239</td>
                            <td>23.3%</td>
                        </tr>
                        <tr>
                            <td>Vin Sold</td>
                            <td>221</td>
                            <td>21.5%</td>
                        </tr>
                        <tr>
                            <td>Convo Pending</td>
                            <td>153</td>
                            <td>14.9%</td>
                        </tr>
                        <tr>
                            <td>Convo Established</td>
                            <td>77</td>
                            <td>7.5%</td>
                        </tr>
                        <tr>
                            <td>Dealer Outreach</td>
                            <td>39</td>
                            <td>3.8%</td>
                        </tr>
                        <tr>
                            <td>Clarify Fees</td>
                            <td>36</td>
                            <td>3.51%</td>
                        </tr>
                        <tr>
                            <td>Confirm Price</td>
                            <td>20</td>
                            <td>1.95%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Deal Flow Progress Chart -->
            <div style="margin-top: 32px;">
                <h4 style="margin-bottom: 16px; color: #0f172a; font-size: 1rem; font-weight: 600;">Deal Progress Flow</h4>
                <div class="deal-flow-chart">
                    <div class="flow-container" id="deal-flow-container">
                        <!-- Progressive stages -->
                        <div class="flow-stage">
                            <div class="stage-node" id="dealer-outreach-node">0%</div>
                            <div class="stage-label">Dealer<br>Outreach</div>
                            <div class="stage-percentage" id="dealer-outreach-percent">0 deals</div>
                        </div>
                        <div class="flow-connector"></div>
                        
                        <div class="flow-stage">
                            <div class="stage-node" id="convo-pending-node">0%</div>
                            <div class="stage-label">Convo<br>Pending</div>
                            <div class="stage-percentage" id="convo-pending-percent">0 deals</div>
                        </div>
                        <div class="flow-connector"></div>
                        
                        <div class="flow-stage">
                            <div class="stage-node" id="convo-established-node">0%</div>
                            <div class="stage-label">Convo<br>Established</div>
                            <div class="stage-percentage" id="convo-established-percent">0 deals</div>
                        </div>
                        <div class="flow-connector"></div>
                        
                        <!-- Confirm Car with VIN Sold branch -->
                        <div class="flow-stage-with-branch">
                            <div class="main-flow-path">
                                <div class="flow-stage">
                                    <div class="stage-node" id="confirm-car-node">0%</div>
                                    <div class="stage-label">Confirm<br>Car</div>
                                    <div class="stage-percentage" id="confirm-car-percent">0 deals</div>
                                </div>
                            </div>
                            
                            <!-- VIN Sold branch off -->
                            <div class="side-branch">
                                <div class="branch-connector"></div>
                                <div class="flow-stage branch">
                                    <div class="stage-node dead" id="vin-sold-node">0%</div>
                                    <div class="stage-label">VIN Sold</div>
                                    <div class="stage-percentage" id="vin-sold-percent">0 deals</div>
                                </div>
                            </div>
                        </div>
                        <div class="flow-connector"></div>
                        
                        <div class="flow-stage">
                            <div class="stage-node" id="confirm-price-node">0%</div>
                            <div class="stage-label">Confirm<br>Price</div>
                            <div class="stage-percentage" id="confirm-price-percent">0 deals</div>
                        </div>
                        <div class="flow-connector"></div>
                        
                        <div class="flow-stage">
                            <div class="stage-node" id="clarify-fees-node">0%</div>
                            <div class="stage-label">Clarify<br>Fees</div>
                            <div class="stage-percentage" id="clarify-fees-percent">0 deals</div>
                        </div>
                        <div class="flow-connector"></div>
                        
                        <!-- Analysis as final step -->
                        <div class="flow-stage">
                            <div class="stage-node success" id="analysis-node">0%</div>
                            <div class="stage-label">Analysis</div>
                            <div class="stage-percentage" id="analysis-percent">0 deals</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Dealership Rankings Section -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">Dealership Fee Transparency Rankings</div>
                <div class="tooltip-container">
                    <div class="tooltip-icon">i</div>
                    <div class="tooltip-content">
                        Dealerships are ranked based on their fee transparency and disclosure practices across all analysis-stage deals. Only dealerships with analysis-stage deals are included.
                    </div>
                </div>
            </div>
            
            <!-- Grading Legend -->
            <div class="grading-legend">
                <div class="legend-header">
                    <h4>Grading System Legend</h4>
                    <button class="legend-toggle" onclick="toggleLegend()">
                        <span class="toggle-text">Hide</span>
                        <span class="toggle-icon">▼</span>
                    </button>
                </div>
                <div class="legend-grid">
                    <div class="legend-section" style="grid-column: 1 / -1;">
                        <h5>Dealership Fee Transparency Grading System</h5>
                        <div class="grading-table-container">
                            <table class="grading-legend-table" style="width: 100%; border-collapse: collapse; margin-top: 12px;">
                                <thead>
                                    <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Grade</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">
                                            Illegitimate/Excessive Fees
                                            <div class="tooltip-container">
                                                <div class="tooltip-icon">i</div>
                                                <div class="tooltip-content">
                                                    The average amount of illegitimate and excessive fees (sum) a dealership charges per deal
                                                </div>
                                            </div>
                                        </th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Transparency/Compliance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;"><span class="legend-badge" style="background: #059669; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">A+</span></td>
                                        <td style="padding: 10px; font-weight: 500;">$0</td>
                                        <td style="padding: 10px;">Properly Disclosed</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;"><span class="legend-badge" style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">A</span></td>
                                        <td style="padding: 10px; font-weight: 500;">$1-$100</td>
                                        <td style="padding: 10px;">Properly Disclosed</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;"><span class="legend-badge" style="background: #34d399; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">A-</span></td>
                                        <td style="padding: 10px; font-weight: 500;">$101-$250</td>
                                        <td style="padding: 10px;">Properly Disclosed</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;"><span class="legend-badge" style="background: #2563eb; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">B+</span></td>
                                        <td style="padding: 10px; font-weight: 500;">$0</td>
                                        <td style="padding: 10px;">Not Proper but Close</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;"><span class="legend-badge" style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">B</span></td>
                                        <td style="padding: 10px; font-weight: 500;">$1-$100</td>
                                        <td style="padding: 10px;">Not Proper but Close</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;"><span class="legend-badge" style="background: #60a5fa; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">B-</span></td>
                                        <td style="padding: 10px; font-weight: 500;">$101-$250</td>
                                        <td style="padding: 10px;">Not Proper but Close</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;"><span class="legend-badge" style="background: #d97706; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">C+</span></td>
                                        <td style="padding: 10px; font-weight: 500;">$251-$499</td>
                                        <td style="padding: 10px;">Proper and/or Not Proper But Close</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;"><span class="legend-badge" style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">C</span></td>
                                        <td style="padding: 10px; font-weight: 500;">$500-$999</td>
                                        <td style="padding: 10px;">Proper and/or Not Proper But Close</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;"><span class="legend-badge" style="background: #fbbf24; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">C-</span></td>
                                        <td style="padding: 10px; font-weight: 500;">$1,000+</td>
                                        <td style="padding: 10px;">Proper and/or Not Proper But Close</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;"><span class="legend-badge" style="background: #dc2626; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">D+</span></td>
                                        <td style="padding: 10px; font-weight: 500;">$0-$250</td>
                                        <td style="padding: 10px;">Guilty of Bait &amp; Switch Pricing</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;"><span class="legend-badge" style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">D</span></td>
                                        <td style="padding: 10px; font-weight: 500;">$251-$500</td>
                                        <td style="padding: 10px;">Guilty of Bait &amp; Switch Pricing</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;"><span class="legend-badge" style="background: #f87171; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">D-</span></td>
                                        <td style="padding: 10px; font-weight: 500;">$501-$749</td>
                                        <td style="padding: 10px;">Guilty of Bait &amp; Switch Pricing</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px;"><span class="legend-badge" style="background: #991b1b; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">F</span></td>
                                        <td style="padding: 10px; font-weight: 500;">$750+</td>
                                        <td style="padding: 10px;">Guilty of Bait &amp; Switch Pricing</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="legend-section">
                        <h5>Bait & Switch Pricing</h5>
                        <div class="data-source-info">
                            <div class="data-item">
                                <span class="data-icon">⚠️</span>
                                <span class="data-text">
                                    <strong>Failure to disclose fees properly on the VDP</strong><br>
                                    Dealership does not properly disclose required fees on their Vehicle Description Page
                                </span>
                            </div>
                            <div class="data-item">
                                <span class="data-icon">🔍</span>
                                <span class="data-text">
                                    <strong>Seem to disclose properly on the VDP but analysis reveals issues</strong><br>
                                    Initial disclosure appears correct, but detailed analysis reveals additional fees and/or fees higher than $100
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="dealership-rankings">
                <div class="empty-state">
                    <h3>Loading Rankings...</h3>
                    <p>Please wait while we calculate dealership grades.</p>
                </div>
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">Recent Deal Activity</div>
            </div>
            
            <!-- Search Box -->
            <div class="search-container" style="margin-bottom: 20px; padding: 0 24px;">
                <div style="position: relative; max-width: 400px;">
                    <input type="text" 
                           id="deal-search-input" 
                           placeholder="Search by deal ID, dealer name, customer, or location..."
                           style="width: 100%; padding: 12px 16px 12px 40px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"
                           oninput="filterDeals(this.value)"
                           onkeypress="if(event.key==='Enter') event.preventDefault()">
                    <i class="fas fa-search" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 14px;"></i>
                    <button onclick="clearSearch()" 
                            id="clear-search-btn"
                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer; padding: 4px; display: none;"
                            title="Clear search">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="search-results-count" style="font-size: 12px; color: #6b7280; margin-top: 4px; display: none;"></div>
            </div>
            
            <div id="activity-table">
                <div class="empty-state">
                    <h3>No Data Available</h3>
                    <p>Start adding metrics and data to see your activity feed here.</p>
                </div>
            </div>
        </div>


    </div>

    <script>
        // Cloud storage configuration (same as main page)
        const JSONBIN_API_KEY = '$2a$10$SEnNfh62rZ5cbmvsRc5iGu5FElaadU.JCpjWywSTIWkdZWEWvt3.i';
        let JSONBIN_BIN_ID = '689168af7b4b8670d8ad55e0';
        const JSONBIN_URL = 'https://api.jsonbin.io/v3/b';

        // Sample data structure for metrics
        let metricsData = {
            dealerships: {
                total: 0,
                change: 0,
                target: 200
            },
            interactions: {
                total: 0,
                change: 0,
                target: 2000
            },
            successRate: {
                current: 0,
                change: 0,
                target: 85
            },
            responseTime: {
                current: 0,
                change: 0,
                target: 2
            },
            dealSummary: {
                totalDeals: 1026,
                analysisDeals: 239,
                analysisPct: 23.29,
                pendingDeals: 225,
                pendingPct: 21.93,
                states: [
                    { state: "Confirm Car", count: 241, percent: 23.5 },
                    { state: "Analysis", count: 239, percent: 23.3 },
                    { state: "Vin Sold", count: 221, percent: 21.5 },
                    { state: "Convo Pending", count: 153, percent: 14.9 },
                    { state: "Convo Established", count: 77, percent: 7.5 },
                    { state: "Dealer Outreach", count: 39, percent: 3.8 },
                    { state: "Clarify Fees", count: 36, percent: 3.51 },
                    { state: "Confirm Price", count: 20, percent: 1.95 }
                ]
            },
            mysteryShopMetrics: {
                scoredMysteryShops: 594,
                targetDealershipsPct: 29.7,
                avgPerDealership: 2.97
            },
            recentActivity: [],
            lastUpdated: new Date().toISOString()
        };

        // Load data from API
        async function loadMetricsData() {
            try {
                console.log('Loading data from API...');
                
                let hasData = false;
                
                // Load deal summary from API
                const dealSummaryResponse = await fetch('/api/deal-summary');
                if (dealSummaryResponse.ok) {
                    const dealSummaryData = await dealSummaryResponse.json();
                    
                    // Check if we got actual data (not error response)
                    if (dealSummaryData && dealSummaryData.totalDeals !== undefined) {
                        metricsData.dealSummary = {
                            totalDeals: dealSummaryData.totalDeals,
                            analysisDeals: dealSummaryData.analysisDeals,
                            analysisPct: dealSummaryData.analysisPct,
                            analysisProgressPct: dealSummaryData.analysisProgressPct,
                            totalAnalysisNeeded: dealSummaryData.totalAnalysisNeeded,
                            pendingDeals: dealSummaryData.pendingDeals,
                            pendingPct: dealSummaryData.pendingPct,
                            states: dealSummaryData.states
                        };
                        
                        // Mystery shop metrics will be calculated after loading dealership analysis data
                        metricsData.mysteryShopMetrics = {
                            scoredMysteryShops: dealSummaryData.analysisDeals, // Number at analysis stage
                            targetDealershipsPct: 0, // Will be updated with correct data
                            avgPerDealership: 0 // Will be updated with correct data
                        };
                        
                        hasData = true;
                        console.log('Deal summary loaded:', dealSummaryData);
                        console.log('Mystery shop metrics calculated:', metricsData.mysteryShopMetrics);
                    }
                } else {
                    console.error('Deal summary API error:', dealSummaryResponse.status, dealSummaryResponse.statusText);
                }

                // Load recent activity from API
                const activityResponse = await fetch('/api/recent-activity');
                if (activityResponse.ok) {
                    const activityData = await activityResponse.json();
                    if (activityData && !activityData.error) {
                        metricsData.recentActivity = activityData;
                        originalActivityData = [...activityData]; // Store original data for search filtering
                        console.log('Recent activity loaded:', activityData);
                    }
                } else {
                    console.error('Recent activity API error:', activityResponse.status, activityResponse.statusText);
                }
                
                if (hasData) {
                    hideLoadingState();
                    updateMetricsDisplay();
                } else {
                    console.error('No data received from APIs');
                    showConnectionError();
                }
            } catch (error) {
                console.error('Error loading metrics data:', error);
                showConnectionError();
            }
        }

        // Update the display with current metrics
        function updateMetricsDisplay() {
            // Update deal summary
            updateDealSummary();

            // Update mystery shop metrics
            updateMysteryShopMetrics();

            // Update activity table if there's data
            if (metricsData.recentActivity && metricsData.recentActivity.length > 0) {
                updateActivityTable();
            }

                            // Load dealership analysis data
                loadDealershipAnalysisData().then(() => {
                    // Load mystery shop metrics data
                    loadMysteryShopMetrics();
                    
                    // Load driver metrics data
                    loadDriverMetricsData();

                    // Load dealership rankings
                    loadDealershipRankings();
                });

        }

        // Update activity table
        function updateActivityTable() {
            const tableContainer = document.getElementById('activity-table');
            tableContainer.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Activity</th>
                            <th>State</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${metricsData.recentActivity.map(activity => `
                            <tr>
                                <td>${activity.date}</td>
                                <td>
                                    <div style="margin-bottom: 4px;">
                                        <strong>Deal ${activity.deal_id}</strong> - ${activity.dealer_name}
                                    </div>
                                    <div style="font-size: 0.875rem; color: #64748b;">
                                        ${activity.dealer_location}
                                    </div>
                                </td>
                                <td><span class="status-badge status-${activity.status}">${activity.deal_state}</span></td>
                                <td>
                                    <a href="deal-details.html?id=${activity.deal_id}" 
                                       class="nav-link" 
                                       style="padding: 4px 8px; font-size: 0.75rem; text-decoration: none;">
                                        <i class="fas fa-search"></i> View Details
                                    </a>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Store original activity data for filtering
        let originalActivityData = [];
        let searchTimeout;

        // Search all deals using the comprehensive API
        async function filterDeals(searchTerm) {
            const searchInput = document.getElementById('deal-search-input');
            const clearBtn = document.getElementById('clear-search-btn');
            const resultsCount = document.getElementById('search-results-count');
            
            // Clear existing timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Show/hide clear button
            if (searchTerm.length > 0) {
                clearBtn.style.display = 'block';
                resultsCount.style.display = 'block';
                resultsCount.textContent = 'Searching...';
            } else {
                clearBtn.style.display = 'none';
                resultsCount.style.display = 'none';
                // Reset to original recent activity data
                metricsData.recentActivity = [...originalActivityData];
                updateActivityTable();
                return;
            }
            
            // Debounce the search to avoid too many API calls
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/deals-search?q=${encodeURIComponent(searchTerm)}`);
                    if (response.ok) {
                        const searchData = await response.json();
                        
                        // Update results count
                        resultsCount.textContent = `${searchData.total} deals found`;
                        
                        // Update the displayed data with search results
                        metricsData.recentActivity = searchData.deals;
                        updateActivityTable();
                        
                        console.log('Search completed:', searchData);
                    } else {
                        console.error('Search API error:', response.status, response.statusText);
                        resultsCount.textContent = 'Search failed';
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    resultsCount.textContent = 'Search error';
                }
            }, 300); // Wait 300ms after user stops typing
        }

        // Clear search
        function clearSearch() {
            const searchInput = document.getElementById('deal-search-input');
            const clearBtn = document.getElementById('clear-search-btn');
            const resultsCount = document.getElementById('search-results-count');
            
            searchInput.value = '';
            clearBtn.style.display = 'none';
            resultsCount.style.display = 'none';
            
            // Reset to original data
            metricsData.recentActivity = [...originalActivityData];
            updateActivityTable();
        }

        // Update deal summary
        function updateDealSummary() {
            const dealData = metricsData.dealSummary;
            
            // Add null checks to prevent errors
            if (!dealData) {
                console.error('dealData is undefined');
                return;
            }
            

            
            // Update progress bar with null checks
            const progressPercentage = document.getElementById('analysis-progress-percentage');
            const progressText = document.getElementById('analysis-progress-text');
            const progressFill = document.getElementById('analysis-progress-fill');
            
            const analysisProgressPct = dealData.analysisProgressPct || 0;
            const analysisDeals = dealData.analysisDeals || 0;
            const totalAnalysisNeeded = dealData.totalAnalysisNeeded || 0;
            
            progressPercentage.textContent = `${analysisProgressPct}%`;
            progressText.textContent = `${analysisDeals.toLocaleString()} of ${totalAnalysisNeeded.toLocaleString()} needed`;
            progressFill.style.width = `${analysisProgressPct}%`;
            
            // Update progress bar color based on percentage toward goal
            if (analysisProgressPct >= 50) {
                progressFill.style.background = 'linear-gradient(90deg, #10b981, #059669)'; // Green
            } else if (analysisProgressPct >= 25) {
                progressFill.style.background = 'linear-gradient(90deg, #3b82f6, #1d4ed8)'; // Blue
            } else {
                progressFill.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)'; // Orange
            }
            
            // Update deal states table with null checks
            const tableBody = document.getElementById('deal-states-body');
            
            // Define tooltip descriptions for deal states
            const stateDescriptions = {
                'vin_sold': 'VIN is no longer for sale',
                'open': "Dealer outreach hasn't been completed", 
                'dealer_outreach': "We submitted form on dealer's website",
                'convo_pending': 'Dealer outreach completed and waiting to get an email from the dealer',
                'convo_established': 'Dealer outreach completed and waiting to get an email from the dealer',
                'confirm_car': 'It is confirmed that the car is still available and now we are asking the dealer about price',
                'confirm_price': "We've received a price from the dealer",
                'clarify_fees': "We've received an OTD price and how we are asking the dealer questions about fees we've found",
                'clarify_fees_answered': 'Dealer answered all of our questions about the fees found',
                'clarify_fees_unanswered': "Dealer didn't answer our questions about the fees found",
                'perform_analysis': 'We have all the info to begin the analysis',
                'write_report': 'We are working on the analysis',
                'send_report': 'Analysis complete',
                'analysis': 'Analysis complete',
                'credit_offer': 'Credit offer received from dealer',
                'won': 'Deal completed successfully'
            };
            
            if (dealData.states && Array.isArray(dealData.states)) {
                tableBody.innerHTML = dealData.states.map((state, index) => `
                    <tr>
                        <td>
                            ${state.state || ''}
                            ${stateDescriptions[state.state] ? `
                                <div class="tooltip-container">
                                    <div class="tooltip-icon">i</div>
                                    <div class="tooltip-content">
                                        ${stateDescriptions[state.state]}
                                    </div>
                                </div>
                            ` : ''}
                        </td>
                        <td>${(state.count || 0).toLocaleString()}</td>
                        <td>${state.percent || 0}%</td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="3">No data available</td></tr>';
            }
            
            // Update the deal flow chart
            updateDealFlowChart(dealData);
        }

        // Update deal flow chart
        function updateDealFlowChart(dealData) {
            if (!dealData || !dealData.states || !Array.isArray(dealData.states)) {
                console.error('dealData.states is not available for flow chart');
                return;
            }
            
            // Create a map for easy state lookup
            const stateMap = {};
            dealData.states.forEach(state => {
                const normalizedKey = state.state.toLowerCase().replace(/\s+/g, '_');
                stateMap[normalizedKey] = {
                    count: state.count || 0,
                    percent: state.percent || 0
                };
            });
            
            // Debug: log the state mapping
            console.log('State mapping for flow chart:', stateMap);
            
            // Define the flow stages in order
            const flowStages = [
                { key: 'dealer_outreach', elementId: 'dealer-outreach' },
                { key: 'convo_pending', elementId: 'convo-pending' },
                { key: 'convo_established', elementId: 'convo-established' },
                { key: 'confirm_car', elementId: 'confirm-car' },
                { key: 'confirm_price', elementId: 'confirm-price' },
                { key: 'clarify_fees', elementId: 'clarify-fees' },
                { key: 'analysis', elementId: 'analysis' },
                { key: 'vin_sold', elementId: 'vin-sold' }
            ];
            
            // Calculate size scaling based on percentages
            const getCircleSize = (percentage) => {
                // Base size 40px, scale up to 80px based on percentage
                // Max percentage gets 80px, min gets 40px
                const maxPercent = Math.max(...dealData.states.map(s => s.percent || 0));
                const minPercent = Math.min(...dealData.states.filter(s => s.percent > 0).map(s => s.percent || 0));
                
                if (maxPercent === minPercent) return 50; // Default size if all same
                
                const ratio = (percentage - minPercent) / (maxPercent - minPercent);
                return Math.round(40 + (ratio * 40)); // Scale from 40px to 80px
            };
            
            // Update each stage
            flowStages.forEach(stage => {
                const stateData = stateMap[stage.key];
                if (stateData) {
                    // Update percentage in circle
                    const nodeElement = document.getElementById(`${stage.elementId}-node`);
                    if (nodeElement) {
                        nodeElement.textContent = `${stateData.percent}%`;
                        
                        // Scale circle size based on percentage
                        const circleSize = getCircleSize(stateData.percent);
                        nodeElement.style.width = `${circleSize}px`;
                        nodeElement.style.height = `${circleSize}px`;
                        nodeElement.style.fontSize = `${Math.max(0.6, circleSize / 80)}rem`;
                    }
                    
                    // Update count below
                    const percentElement = document.getElementById(`${stage.elementId}-percent`);
                    if (percentElement) {
                        percentElement.textContent = `${stateData.count.toLocaleString()} deals`;
                    }
                }
            });
        }

        // Update mystery shop metrics
        function updateMysteryShopMetrics() {
            const mysteryData = metricsData.mysteryShopMetrics;
            
            // Add null checks to prevent errors
            if (!mysteryData) {
                console.error('mysteryData is undefined');
                return;
            }
            
            // Update mystery shop metrics with null checks
            document.getElementById('scored-mystery-shops').textContent = (mysteryData.scoredMysteryShops || 0).toLocaleString();
            document.getElementById('target-dealerships-pct').textContent = `${mysteryData.targetDealershipsPct || 0}%`;
            document.getElementById('avg-per-dealership').textContent = (mysteryData.avgPerDealership || 0).toFixed(2);
        }

        // Show loading state
        function showLoadingState() {
            // Remove any existing loading or error messages
            const existingLoading = document.getElementById('loading-overlay');
            const existingError = document.querySelector('.error-container');
            if (existingLoading) existingLoading.remove();
            if (existingError) existingError.remove();
            
            // Create overlay loading state
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'loading-overlay';
            loadingOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(2px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;
            
            loadingOverlay.innerHTML = `
                <div style="text-align: center;">
                    <div style="width: 50px; height: 50px; border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <div style="color: #64748b; font-weight: 500; font-size: 1rem;">Loading data...</div>
                </div>
            `;
            
            // Add CSS animation if not already present
            if (!document.querySelector('#loading-spinner-style')) {
                const style = document.createElement('style');
                style.id = 'loading-spinner-style';
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(loadingOverlay);
        }

        // Hide loading state
        function hideLoadingState() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.opacity = '0';
                loadingOverlay.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    if (loadingOverlay.parentNode) {
                        loadingOverlay.parentNode.removeChild(loadingOverlay);
                    }
                }, 300);
            }
        }

        // Show connection error message
        function showConnectionError() {
            // Hide loading state first
            hideLoadingState();
            
            // Create overlay error state
            const errorOverlay = document.createElement('div');
            errorOverlay.className = 'error-container';
            errorOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(2px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;
            
            errorOverlay.innerHTML = `
                <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; padding: 40px; text-align: center; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <div style="color: #dc2626; font-size: 3rem; margin-bottom: 16px;">⚠️</div>
                    <h2 style="color: #dc2626; font-size: 1.5rem; margin-bottom: 12px; font-weight: 600;">Database Connection Error</h2>
                    <p style="color: #7f1d1d; font-size: 1rem; margin-bottom: 20px; line-height: 1.5;">
                        Unable to connect to the database. Please ensure you are connected to the VPN and try again.
                    </p>
                    <button onclick="location.reload()" style="
                        background: #dc2626;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 6px;
                        font-size: 0.875rem;
                        font-weight: 500;
                        cursor: pointer;
                        transition: background 0.2s ease;
                    " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                        Retry Connection
                    </button>
                </div>
            `;
            
            document.body.appendChild(errorOverlay);
        }



        // Load dealership analysis data
        async function loadDealershipAnalysisData() {
            try {
                const response = await fetch('/api/dealership-analysis');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update mystery shop metrics with correct data
                    const totalDealerships = data.totalDealerships;
                    const dealershipsWithAnalysis = data.dealershipsWithAnalysis;
                    const analysisDeals = metricsData.dealSummary.analysisDeals;
                    
                    metricsData.mysteryShopMetrics = {
                        scoredMysteryShops: analysisDeals,
                        targetDealershipsPct: parseFloat(((dealershipsWithAnalysis / totalDealerships) * 100).toFixed(1)),
                        avgPerDealership: parseFloat((analysisDeals / totalDealerships).toFixed(2))
                    };
                    
                    // Update the display
                    updateMysteryShopMetrics();
                    
                } else {
                    console.error('Failed to load dealership analysis data');
                }
            } catch (error) {
                console.error('Error loading dealership analysis:', error);
            }
        }


        // Load mystery shop metrics data
        async function loadMysteryShopMetrics() {
            console.log('Loading mystery shop metrics...');
            try {
                const response = await fetch('/api/mystery-shop-metrics');
                console.log('Mystery shop metrics response:', response.status, response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Mystery shop metrics data:', data);
                    updateMysteryShopTable(data);
                } else {
                    console.error('Failed to load mystery shop metrics, status:', response.status);
                    showMysteryShopError();
                }
            } catch (error) {
                console.error('Error loading mystery shop metrics:', error);
                showMysteryShopError();
            }
        }

        // Update mystery shop metrics table
        function updateMysteryShopTable(data) {
            console.log('Updating mystery shop table with data:', data);
            const container = document.getElementById('mystery-shop-metrics');
            
            if (!container) {
                console.error('Mystery shop metrics container not found!');
                return;
            }
            
            if (!data.mystery_shop_metrics || data.mystery_shop_metrics.length === 0) {
                console.log('No mystery shop metrics data, showing error');
                showMysteryShopError();
                return;
            }

            // Ensure all ranges are present with 0 values if missing  
            const allRanges = ['10', '8-9', '5-7', '1-4', '0'];
            const metricsMap = {};
            
            data.mystery_shop_metrics.forEach(item => {
                metricsMap[item.shop_range] = item;
            });

            // Fill in missing ranges with 0 values
            allRanges.forEach(range => {
                if (!metricsMap[range]) {
                    metricsMap[range] = {
                        shop_range: range,
                        dealer_count: 0,
                        percentage: 0.0
                    };
                }
            });

            const tableHtml = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="text-align: left;">No. of Scored Mystery Shops</th>
                                <th style="text-align: right;">% of Dealers</th>
                                <th style="text-align: right;">Number of Dealers</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allRanges.map(range => {
                                const item = metricsMap[range];
                                return `
                                    <tr>
                                        <td style="font-weight: 600;">${range}</td>
                                        <td style="text-align: right;">${item.percentage}%</td>
                                        <td style="text-align: right;">${item.dealer_count.toLocaleString()}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    <div class="table-footer">
                        <p>Total Dealers: ${data.total_dealers.toLocaleString()}</p>
                        <p>Last Updated: ${new Date(data.last_updated).toLocaleString()}</p>
                    </div>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }

        // Show error state for mystery shop metrics
        function showMysteryShopError() {
            const container = document.getElementById('mystery-shop-metrics');
            container.innerHTML = `
                <div class="error-state">
                    <h3>Unable to Load Mystery Shop Metrics</h3>
                    <p>Please check your connection and try refreshing the page.</p>
                </div>
            `;
        }

        // Load driver metrics data
        async function loadDriverMetricsData() {
            try {
                const response = await fetch('/api/driver-metrics');
                if (response.ok) {
                    const data = await response.json();
                    updateDriverMetricsTable(data);
                } else {
                    console.error('Failed to load driver metrics data');
                    document.getElementById('driver-metrics-scoreable').innerHTML = `
                        <div class="empty-state">
                            <h3>Failed to Load Data</h3>
                            <p>Unable to fetch driver metrics data. Please try again.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading driver metrics:', error);
                document.getElementById('driver-metrics-scoreable').innerHTML = `
                    <div class="empty-state">
                        <h3>Connection Error</h3>
                        <p>Unable to connect to the database. Please check your connection.</p>
                    </div>
                `;
            }
        }

        // Update driver metrics table
        function updateDriverMetricsTable(data) {
            const container = document.getElementById('driver-metrics-scoreable');
            const summary = data.summary;
            const timeline = data.timeline;
            
            // Create summary stats
            const statsHtml = `
                <div class="table-stats">
                    <div class="stat-card">
                        <div class="stat-value">${timeline.daysUntilDeadline}</div>
                        <div class="stat-label">Days until Sept. 1</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #10b981;">${summary.pctAchieved}%</div>
                        <div class="stat-label">Achieved Goal (10+)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #3b82f6;">${summary.pctNearGoal}%</div>
                        <div class="stat-label">Near Goal (8-9)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #f59e0b;">${summary.pctGoodProgress}%</div>
                        <div class="stat-label">Good Progress (5-7)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #ef4444;">${timeline.dailyRateNeeded}</div>
                        <div class="stat-label">Daily Rate Needed</div>
                    </div>
                </div>
                
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin: 16px 0;">
                    <h5 style="margin: 0 0 8px 0; color: #0f172a; font-size: 0.875rem; font-weight: 600;">PROGRESS TOWARD GOAL</h5>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 0.875rem;">
                        <div><strong>Total Needed:</strong> ${timeline.totalAnalysisNeeded.toLocaleString()} analysis deals</div>
                        <div><strong>Current:</strong> ${timeline.currentAnalysis.toLocaleString()} analysis deals</div>
                        <div><strong>Still Needed:</strong> ${timeline.analysisStillNeeded.toLocaleString()} analysis deals</div>
                        <div><strong>Deadline:</strong> ${timeline.deadline}</div>
                    </div>
                </div>
            `;

            // Create table
            const tableHtml = `
                <div class="table-container">
                    <table class="enhanced-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Dealership</th>
                                <th>Location</th>
                                <th>Analysis Deals</th>
                                <th>Total Deals</th>
                                <th>Progress to 10</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.dealerships.map((dealer, index) => {
                                const progressTo10 = dealer.analysisDeals >= 10 ? '✅ ACHIEVED!' : `${dealer.dealsNeeded} more needed`;
                                const status = getDriverStatusIndicator(dealer);
                                
                                let rowClass = '';
                                if (dealer.analysisDeals >= 10) rowClass = 'achieved-goal'; // Green for achieved
                                else if (dealer.analysisDeals >= 8) rowClass = 'near-goal'; // Blue for near goal
                                else if (dealer.analysisDeals >= 5) rowClass = 'highlight'; // Yellow for good progress
                                
                                return `
                                    <tr class="${rowClass}">
                                        <td>${index + 1}</td>
                                        <td><strong>${dealer.dealerName}</strong><br><small style="color: #64748b;">ID: ${dealer.dealerId}</small></td>
                                        <td>${dealer.city}, ${dealer.stateCode}</td>
                                        <td><strong style="color: #3b82f6;">${dealer.analysisDeals}/10</strong></td>
                                        <td>${dealer.totalDeals}</td>
                                        <td>${progressTo10}</td>
                                        <td>${status}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = statsHtml + tableHtml;
        }

        // Get driver status indicator
        function getDriverStatusIndicator(dealer) {
            if (dealer.analysisDeals >= 10) {
                return '<span class="progress-indicator progress-excellent"></span>Goal Achieved';
            } else if (dealer.analysisDeals >= 8) {
                return '<span class="progress-indicator progress-good"></span>Near Goal';
            } else if (dealer.analysisDeals >= 5) {
                return '<span class="progress-indicator progress-average"></span>Good Progress';
            } else if (dealer.analysisDeals >= 1) {
                return '<span class="progress-indicator progress-poor"></span>Needs Work';
            } else {
                return '<span class="progress-indicator progress-poor"></span>No Analysis Deals';
            }
        }


        // Load dealership rankings
        async function loadDealershipRankings() {
            try {
                const response = await fetch('/api/dealership-rankings');
                if (response.ok) {
                    const data = await response.json();
                    updateDealershipRankings(data);
                } else {
                    console.error('Failed to load dealership rankings');
                    document.getElementById('dealership-rankings').innerHTML = `
                        <div class="empty-state">
                            <h3>Failed to Load Rankings</h3>
                            <p>Unable to fetch dealership ranking data. Please try again.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading dealership rankings:', error);
                document.getElementById('dealership-rankings').innerHTML = `
                    <div class="empty-state">
                        <h3>Connection Error</h3>
                        <p>Unable to connect to the database. Please check your connection.</p>
                    </div>
                `;
            }
        }

        // Update dealership rankings display
        function updateDealershipRankings(data) {
            const container = document.getElementById('dealership-rankings');
            
            if (!data.rankings || data.rankings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Rankings Available</h3>
                        <p>No dealerships with analysis-stage deals found.</p>
                    </div>
                `;
                return;
            }
            


            // Create summary stats for new grading system
            const gradeDistribution = { 
                'A+': 0, A: 0, 'A-': 0, 
                'B+': 0, B: 0, 'B-': 0, 
                'C+': 0, C: 0, 'C-': 0, 
                'D+': 0, D: 0, 'D-': 0, 
                F: 0 
            };
            
            // All grades will show N/A for now since we changed the system
            // data.rankings.forEach(dealer => {
            //     if (dealer.grading.grade !== 'N/A' && gradeDistribution.hasOwnProperty(dealer.grading.grade)) {
            //         gradeDistribution[dealer.grading.grade]++;
            //     }
            // });

            const summaryHtml = `
                <div class="table-stats">
                    <div class="stat-card">
                        <div class="stat-value">${data.total_dealers}</div>
                        <div class="stat-label">Total Dealerships</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #059669;">N/A</div>
                        <div class="stat-label">A+ Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #10b981;">N/A</div>
                        <div class="stat-label">A Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #34d399;">N/A</div>
                        <div class="stat-label">A- Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #2563eb;">N/A</div>
                        <div class="stat-label">B+ Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #3b82f6;">N/A</div>
                        <div class="stat-label">B Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #60a5fa;">N/A</div>
                        <div class="stat-label">B- Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #d97706;">N/A</div>
                        <div class="stat-label">C+ Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #f59e0b;">N/A</div>
                        <div class="stat-label">C Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #fbbf24;">N/A</div>
                        <div class="stat-label">C- Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #dc2626;">N/A</div>
                        <div class="stat-label">D+ Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #ef4444;">N/A</div>
                        <div class="stat-label">D Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #f87171;">N/A</div>
                        <div class="stat-label">D- Grade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #991b1b;">N/A</div>
                        <div class="stat-label">F Grade</div>
                    </div>
                </div>
            `;

            // Create rankings table
            const tableHtml = `
                <div class="table-container">
                    <table class="enhanced-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Dealership</th>
                                <th>Location</th>
                                <th>Overall Grade</th>
                                <th>Excessive/Illegitimate Fees</th>
                                <th>Transparency/Compliance</th>
                                <th>Deals Analyzed</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.rankings.map((dealer, index) => {
                                const grading = dealer.grading;
                                const gradeColor = grading.color;
                                
                                return `
                                    <tr>
                                        <td><strong>${index + 1}</strong></td>
                                        <td><strong>${dealer.dealer_name}</strong></td>
                                        <td>${dealer.location}</td>
                                        <td>
                                            <span class="status-badge" style="background: #64748b; color: white;">
                                                N/A
                                            </span>
                                        </td>
                                        <td>
                                            <div class="tooltip-container">
                                                ${(() => {
                                                    const totalFees = (grading.averageFees?.excessive || 0) + (grading.averageFees?.illegitimate || 0);
                                                    let bracket = '';
                                                    let color = '#64748b';
                                                    
                                                    if (totalFees === 0) {
                                                        bracket = '$0';
                                                        color = '#059669';
                                                    } else if (totalFees >= 1000) {
                                                        bracket = '$1,000+';
                                                        color = '#fbbf24';
                                                    } else if (totalFees >= 750) {
                                                        bracket = '$750+';
                                                        color = '#991b1b';
                                                    } else if (totalFees >= 501) {
                                                        bracket = '$501-$749';
                                                        color = '#f87171';
                                                    } else if (totalFees >= 500) {
                                                        bracket = '$500-$999';
                                                        color = '#f59e0b';
                                                    } else if (totalFees >= 251) {
                                                        bracket = '$251-$499';
                                                        color = '#d97706';
                                                    } else if (totalFees >= 101) {
                                                        bracket = '$101-$250';
                                                        color = '#34d399';
                                                    } else if (totalFees >= 1) {
                                                        bracket = '$1-$100';
                                                        color = '#10b981';
                                                    } else {
                                                        bracket = '$0';
                                                        color = '#059669';
                                                    }
                                                    
                                                    return `<span class="status-badge" style="background: ${color}; color: white;">${bracket}</span>`;
                                                })()}
                                                <div class="tooltip-content">
                                                    <strong>Average Excessive Fees per Deal:</strong> $${grading.averageFees?.excessive?.toFixed(2) || '0.00'}<br>
                                                    <strong>Average Illegitimate Fees per Deal:</strong> $${grading.averageFees?.illegitimate?.toFixed(2) || '0.00'}<br>
                                                    <strong>Total Combined Fees:</strong> $${((grading.averageFees?.excessive || 0) + (grading.averageFees?.illegitimate || 0)).toFixed(2)}<br>
                                                    <strong>Based on:</strong> ${grading.dealCount} deals
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-badge" style="background: #64748b; color: white;">
                                                N/A
                                            </span>
                                        </td>
                                        <td>${grading.dealCount}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = summaryHtml + tableHtml;
        }

        // Toggle legend visibility
        function toggleLegend() {
            const legendGrid = document.querySelector('.legend-grid');
            const toggleButton = document.querySelector('.legend-toggle');
            const toggleText = document.querySelector('.toggle-text');
            const toggleIcon = document.querySelector('.toggle-icon');
            
            if (legendGrid.classList.contains('collapsed')) {
                legendGrid.classList.remove('collapsed');
                toggleButton.classList.remove('collapsed');
                toggleText.textContent = 'Hide';
            } else {
                legendGrid.classList.add('collapsed');
                toggleButton.classList.add('collapsed');
                toggleText.textContent = 'Show';
            }
        }

        // Refresh data function
        function refreshData() {
            showLoadingState();
            loadMetricsData();
        }

        // Initialize the page
        async function initializeMetricsPage() {
            showLoadingState();
            await loadMetricsData();
        }

        // Issues Management
        let issues = [];
        let currentFilter = 'incomplete'; // Default to "Need to fix"

        async function loadIssues() {
            try {
                const response = await fetch('/api/mystery-shopping-issues');
                if (response.ok) {
                    const data = await response.json();
                    issues = data.issues;
                    renderIssues();
                } else {
                    console.error('Failed to load issues');
                    showIssuesError();
                }
            } catch (error) {
                console.error('Error loading issues:', error);
                showIssuesError();
            }
        }

        async function addNewIssue() {
            try {
                const response = await fetch('/api/mystery-shopping-issues', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: 'New issue...' })
                });

                if (response.ok) {
                    await loadIssues();
                    
                    // Focus on the new issue text input
                    setTimeout(() => {
                        const issueInputs = document.querySelectorAll('.issue-text');
                        if (issueInputs.length > 0) {
                            const lastInput = issueInputs[issueInputs.length - 1];
                            lastInput.select();
                        }
                    }, 100);
                } else {
                    console.error('Failed to create issue');
                }
            } catch (error) {
                console.error('Error creating issue:', error);
            }
        }

        async function deleteIssue(issueId) {
            try {
                const response = await fetch(`/api/mystery-shopping-issues/${issueId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadIssues();
                } else {
                    console.error('Failed to delete issue');
                }
            } catch (error) {
                console.error('Error deleting issue:', error);
            }
        }

        async function toggleIssue(issueId) {
            const issue = issues.find(i => i.id === issueId);
            if (!issue) return;
            
            try {
                const response = await fetch(`/api/mystery-shopping-issues/${issueId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        text: issue.text,
                        completed: !issue.completed 
                    })
                });

                if (response.ok) {
                    await loadIssues();
                } else {
                    console.error('Failed to toggle issue');
                }
            } catch (error) {
                console.error('Error toggling issue:', error);
            }
        }

        async function updateIssueText(issueId, newText) {
            const issue = issues.find(i => i.id === issueId);
            if (!issue || issue.text === newText.trim()) return;
            
            try {
                const response = await fetch(`/api/mystery-shopping-issues/${issueId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        text: newText.trim(),
                        completed: issue.completed 
                    })
                });

                if (response.ok) {
                    // Update local data without full reload for smoother UX
                    issue.text = newText.trim();
                } else {
                    console.error('Failed to update issue text');
                }
            } catch (error) {
                console.error('Error updating issue text:', error);
            }
        }

        function setIssueFilter(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            renderIssues();
        }

        function getFilteredIssues() {
            switch (currentFilter) {
                case 'completed':
                    return issues.filter(issue => issue.completed);
                case 'incomplete':
                    return issues.filter(issue => !issue.completed);
                case 'all':
                default:
                    return issues;
            }
        }

        function renderIssues() {
            const issuesList = document.getElementById('issues-list');
            const emptyState = document.getElementById('empty-issues');
            const filteredIssues = getFilteredIssues();
            
            if (filteredIssues.length === 0) {
                emptyState.classList.remove('hidden');
                issuesList.innerHTML = '';
                
                // Update empty state message based on filter
                const emptyTitle = emptyState.querySelector('h3');
                const emptyText = emptyState.querySelector('p');
                
                switch (currentFilter) {
                    case 'completed':
                        emptyTitle.textContent = 'No Fixed Issues';
                        emptyText.textContent = 'Completed issues will appear here.';
                        break;
                    case 'incomplete':
                        emptyTitle.textContent = 'No Issues to Fix';
                        emptyText.textContent = 'Great! All issues are resolved.';
                        break;
                    default:
                        emptyTitle.textContent = 'No Issues';
                        emptyText.textContent = 'Start tracking problems and concerns.';
                }
                return;
            }
            
            emptyState.classList.add('hidden');
            
            // Sort by creation date (oldest first, newest at bottom)
            const sortedIssues = [...filteredIssues].sort((a, b) => 
                new Date(a.created_at) - new Date(b.created_at)
            );
            
            issuesList.innerHTML = sortedIssues.map(issue => `
                <div class="issue-item" data-issue-id="${issue.id}">
                    <div class="issue-checkbox ${issue.completed ? 'checked' : ''}" 
                         onclick="toggleIssue(${issue.id})">
                    </div>
                    <input type="text" 
                           class="issue-text ${issue.completed ? 'completed' : ''}" 
                           value="${issue.text}"
                           onblur="updateIssueText(${issue.id}, this.value)"
                           onkeypress="if(event.key==='Enter') this.blur()">
                    <div class="issue-actions">
                        <button class="issue-delete" onclick="deleteIssue(${issue.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showIssuesError() {
            const issuesList = document.getElementById('issues-list');
            issuesList.innerHTML = `
                <div class="empty-state">
                    <h3>Failed to Load Issues</h3>
                    <p>Please try refreshing the page.</p>
                </div>
            `;
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initializeMetricsPage();
                loadIssues();
            });
        } else {
            initializeMetricsPage();
            loadIssues();
        }




    </script>

    <!-- AI Chat Overlay -->
    <div id="chat-overlay" class="chat-overlay">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-robot"></i>
                    Ralph AI Assistant
                </div>
                <button class="chat-close" onclick="toggleChat()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="message assistant-message">
                    <div class="message-content">
                        <strong>Hi! I'm your AI assistant for Project Ralph.</strong><br>
                        Ask me questions about your deals data like:
                        <ul>
                            <li>"What percentage of dealers have at least 3 deals in analysis stage?"</li>
                            <li>"Show me the top 10 dealers by deal count"</li>
                            <li>"How many deals were created this month?"</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <input 
                    type="text" 
                    id="chat-input" 
                    placeholder="Ask me about your deals data..." 
                    onkeypress="handleChatKeypress(event)"
                />
                <button id="chat-send" onclick="sendChatMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Toggle Button -->
    <button id="chat-toggle" class="chat-toggle" onclick="toggleChat()" title="Open AI Assistant">
        <i class="fas fa-robot"></i>
    </button>

    <style>
        /* Chat Overlay Styles */
        .chat-overlay {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid #e2e8f0;
            display: none;
            flex-direction: column;
            z-index: 1000;
            font-family: 'Inter', sans-serif;
        }

        .chat-overlay.open {
            display: flex;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 16px;
        }

        .assistant-message .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 12px 12px 12px 4px;
            border-left: 4px solid #667eea;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            line-height: 1.5;
        }

        .user-message .message-content {
            background: #667eea;
            color: white;
            padding: 12px 16px;
            border-radius: 12px 12px 4px 12px;
            margin-left: 60px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .message-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 4px 0;
            font-size: 0.9rem;
            color: #64748b;
        }

        .query-results {
            margin-top: 12px;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 12px;
        }

        .query-results h4 {
            margin: 0 0 8px 0;
            color: #475569;
            font-size: 0.875rem;
        }

        .results-table {
            width: 100%;
            font-size: 0.75rem;
            border-collapse: collapse;
        }

        .results-table th,
        .results-table td {
            padding: 4px 8px;
            text-align: left;
            border-bottom: 1px solid #cbd5e1;
        }

        .results-table th {
            background: #e2e8f0;
            font-weight: 600;
        }

        .chat-input-container {
            padding: 16px;
            border-top: 1px solid #e2e8f0;
            background: white;
            border-radius: 0 0 12px 12px;
            display: flex;
            gap: 8px;
        }

        #chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s;
        }

        #chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #chat-send {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        #chat-send:hover {
            background: #5a67d8;
        }

        #chat-send:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .chat-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
            font-size: 1.25rem;
            z-index: 999;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .chat-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .chat-toggle.hidden {
            display: none;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #64748b;
            font-style: italic;
            font-size: 0.875rem;
        }

        .typing-dots {
            display: inline-flex;
            gap: 2px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            background: #64748b;
            border-radius: 50%;
            animation: typing 1.5s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .chat-overlay {
                width: calc(100vw - 40px);
                height: calc(100vh - 40px);
                bottom: 20px;
                right: 20px;
            }
            
            .user-message .message-content {
                margin-left: 20px;
            }
        }
    </style>

    <script>
        let chatOpen = false;

        function toggleChat() {
            const overlay = document.getElementById('chat-overlay');
            const toggle = document.getElementById('chat-toggle');
            
            chatOpen = !chatOpen;
            
            if (chatOpen) {
                overlay.classList.add('open');
                toggle.classList.add('hidden');
                document.getElementById('chat-input').focus();
            } else {
                overlay.classList.remove('open');
                toggle.classList.remove('hidden');
            }
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const sendButton = document.getElementById('chat-send');
            const messagesContainer = document.getElementById('chat-messages');
            
            const message = input.value.trim();
            if (!message) return;
            
            // Clear input and disable send button
            input.value = '';
            sendButton.disabled = true;
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Add typing indicator
            const typingId = addTypingIndicator();
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator(typingId);
                
                if (response.ok) {
                    // Add assistant response
                    addMessageToChat('assistant', data.message, data.sql, data.results);
                } else {
                    addMessageToChat('assistant', `Error: ${data.error || 'Failed to process your request'}`);
                }
                
            } catch (error) {
                console.error('Chat error:', error);
                removeTypingIndicator(typingId);
                addMessageToChat('assistant', 'Sorry, I encountered an error processing your request. Please try again.');
            } finally {
                sendButton.disabled = false;
            }
        }

        function addMessageToChat(role, content, sql = null, results = null) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            
            let messageContent = `<div class="message-content">${formatMessageContent(content)}`;
            
            // Add query results if available
            if (results) {
                messageContent += '<div class="query-results">';
                
                if (results.error) {
                    messageContent += `<div class="error-message">Query Error: ${results.error}</div>`;
                } else if (results.rows && results.rows.length > 0) {
                    messageContent += '<h4>Query Results:</h4>';
                    messageContent += '<table class="results-table">';
                    
                    // Add headers
                    const headers = Object.keys(results.rows[0]);
                    messageContent += '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
                    
                    // Add rows (limit to first 10 for display)
                    const displayRows = results.rows.slice(0, 10);
                    messageContent += displayRows.map(row => 
                        '<tr>' + headers.map(h => `<td>${row[h] || ''}</td>`).join('') + '</tr>'
                    ).join('');
                    
                    messageContent += '</table>';
                    
                    if (results.rows.length > 10) {
                        messageContent += `<p style="font-size: 0.75rem; color: #64748b; margin-top: 8px;">Showing 10 of ${results.rowCount} results</p>`;
                    }
                } else {
                    messageContent += '<p>No results found</p>';
                }
                
                messageContent += '</div>';
            }
            
            messageContent += '</div>';
            messageDiv.innerHTML = messageContent;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatMessageContent(content) {
            // Convert markdown-style formatting to HTML
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/```sql\n([\s\S]*?)\n```/g, '<pre style="background: #f1f5f9; padding: 8px; border-radius: 4px; font-size: 0.75rem; overflow-x: auto;"><code>$1</code></pre>')
                .replace(/\n/g, '<br>');
        }

        function addTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            const typingId = 'typing-' + Date.now();
            
            typingDiv.id = typingId;
            typingDiv.className = 'message assistant-message';
            typingDiv.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        AI is thinking
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return typingId;
        }

        function removeTypingIndicator(typingId) {
            const typingElement = document.getElementById(typingId);
            if (typingElement) {
                typingElement.remove();
            }
        }
    </script>
</body>
</html> 